*DECLARACION CONSTANTES

SCDR   EQU   $102F
SCCR2  EQU   $102D
SCSR   EQU   $102E
SCCR1  EQU   $102C
BAUD   EQU   $102B
HPRIO  EQU   $103C
SPCR   EQU   $1028
CSCTL  EQU   $105D
OPT2   EQU   $1038
PORTG  EQU   $1002
DDRA   EQU   $1001
DDRD   EQU   $1009
DDRG   EQU   $1003

*DECLARACION DE VARIABLES

ORDEN EQU  $0000
TEMP_H EQU $0001
TEMP  EQU  $0002
U     EQU  $0010
D     EQU  $0011
C     EQU  $0012
UM    EQU  $0013
CONT  EQU  $0020
FED   EQU  $0021
FER   EQU  $0022
FCD   EQU  $0023
FCR   EQU  $0024

*PROGRAMA

      ORG $8000
      
      LDS #$00FF
      JSR SERIAL

LIMPIA      
      CLR ORDEN
      CLR TEMP_H
      CLR TEMP
      CLR U
      CLR D
      CLR C
      CLR UM
      CLR CONT
      CLR FED
      CLR FER
      CLR FCD
      CLR FCR
      LDX #0
      LDY #0
      JSR BORRA_TODO

INICIO

      LDAA #'?
      STAA ORDEN
CICLO
      LDAA ORDEN
      CMPA #'?
      BEQ  CICLO

      JSR DECIMAL
      LDAB FCD
      CMPB #1
      BEQ STORE_DECIMAL
      JSR ROMANO
      LDAB FCR
      CMPB #1
      BEQ STORE_ROMANO
      JSR MENSAJE_ERROR_SIMBOLO

STORE_ROMANO
      JMP ESPERA_OK

STORE_DECIMAL
      LDX #3
      STAA $10,X
      DEX
      INC TEMP
RELOAD_DATA_DECIMAL
      LDAA #'?
      STAA ORDEN
CICLO_GUARDADO_DECIMAL
      LDAA ORDEN
      CMPA #'?
      BEQ CICLO_GUARDADO_DECIMAL
      CMPA #'=
      BEQ REVISA_CUATRO
      LDAB TEMP
      CMPB #4
      BEQ IMPRIME_ERROR_MAX_DECIMAL
      JSR DECIMAL
      LDAB FED
      CMPB #0
      BNE IMPRIME_ERROR_SIMBOLO
      STAA $10,X
      DEX
      INC TEMP
      JMP RELOAD_DATA_DECIMAL

IMPRIME_ERROR_SIMBOLO
      JSR MENSAJE_ERROR_SIMBOLO
      JMP ESPERA_OK

IMPRIME_ERROR_MAX_DECIMAL
      JSR MENSAJE_ERROR_MAX
      JMP ESPERA_OK

REVISA_CUATRO
      LDX #0
      LDAA TEMP
      CMPA #4
      BLS D2R
      JSR MENSAJE_ERROR_MAX
      JMP ESPERA_OK

*** Convierte decimal a romano ***
D2R

      LDAA TEMP
      CMPA #3
      BEQ ACOMODA3
      CMPA #2
      BEQ ACOMODA2
      CMPA #1
      BEQ ACOMODA1
      
      LDAA UM
      STAA $80,X
      LDAA C
      STAA $81,X
      LDAA D
      STAA $82,X
      LDAA U
      STAA $83,X
      LDAA #'=
      STAA $84,X
      LDAA TEMP
      INCA
      STAA TEMP
      LDX TEMP_H

      LDAB UM
      CMPB #30
      BEQ MD

UMCICLO
      LDAA #'M
      JSR DATARX
      DECB
      CMPB #$30
      BEQ MD
      JMP UMCICLO

ACOMODA3
      LDAA #'=
      STAA $83,X
      *** Baja decena a unidad *** 
      LDAA D
      STAA U
      STAA $82,X
      *** Baja centena a decena ***
      LDAA C
      STAA D
      STAA $81,X
      *** Baja la unidad de millar por centena ***
      LDAA UM
      STAA C
      STAA $80,X
      CLR UM
      LDAA TEMP
      INCA
      STAA TEMP
      LDX TEMP_H
      JMP MD

ACOMODA2
      LDAA #'=
      STAA $82,X
      *** Baja centena a unidad *** 
      LDAA C
      STAA U
      STAA $81,X
      *** Baja unidad de millar a decena ***
      LDAA UM
      STAA D
      STAA $80,X
      *** Limpia datos ***
      CLR C
      CLR UM
      LDAA TEMP
      INCA
      STAA TEMP
      LDX TEMP_H
      JMP MD2

ACOMODA1
      LDAA #'=
      STAA $81,X
      *** Baja unidad de millar a unidad ***
      LDAA UM
      STAA U
      STAA $80,X
      *** Limpia datos ***
      CLR UM
      LDAA TEMP
      INCA
      STAA TEMP
      LDX TEMP_H
      JMP MD3

MD

      LDAB C
      CMPB #$30
      BEQ MD2
      JSR FORMATOCENTENA

MD2

      LDAB D
      CMPB #$30
      BEQ MD3
      JSR FORMATODECENA

MD3

      LDAB U
      CMPB #$30
      BEQ ESPERA_OK
      JSR FORMATOUNIDAD

ESPERA_OK

      LDAA #'?
      STAA ORDEN
CICLO_O
      LDAA ORDEN
      CMPA #'?
      BEQ  CICLO_O
      CMPA #'O
      BEQ CICLO_K
CICLO_K
      LDAA ORDEN
      CMPA #'K
      BNE CICLO_O
      JMP LIMPIA

***********************************
* Unidades
***********************************

FORMATOUNIDAD
      
      LDAA U
      CMPA #$34
      BEQ USPECIAL
      BLO UCICLO
      CMPA #$39
      BEQ USPECIAL9
      CMPA #$35
      BHS USPECIAL5

USPECIAL9
      LDAA #'I
      JSR DATARX
      LDAA #'X
      JSR DATARX
      JMP FINU

UCICLO
      LDAA #'I
      JSR DATARX
      DECB
      CMPB #$30
      BEQ FINU
      JMP UCICLO

USPECIAL5
      LDAA #'V
      JSR DATARX
      SUBB #5
      CMPB #$30
      BHI UCICLO
      JMP FINU

USPECIAL
      LDAA #'I
      JSR DATARX
      LDAA #'V
      JSR DATARX

FINU
      RTS

***********************************
* Dencenas
***********************************

FORMATODECENA
      
      LDAA D
      CMPA #$34
      BEQ DSPECIAL
      BLO DCICLO
      CMPA #$39
      BEQ DSPECIAL9
      CMPA #$35
      BHS DSPECIAL5

DSPECIAL9
      LDAA #'X
      JSR DATARX
      LDAA #'C
      JSR DATARX
      JMP FIND

DCICLO
      LDAA #'X
      JSR DATARX
      DECB
      CMPB #$30
      BEQ FIND
      JMP DCICLO

DSPECIAL5
      LDAA #'L
      JSR DATARX
      SUBB #5
      CMPB #$30
      BHI DCICLO
      JMP FIND

DSPECIAL
      LDAA #'X
      JSR DATARX
      LDAA #'L
      JSR DATARX

FIND
      RTS

***********************************
* Centenas
***********************************

FORMATOCENTENA
      
      LDAA C
      CMPA #$34
      BEQ CSPECIAL
      BLO CCICLO
      CMPA #$39
      BEQ CSPECIAL9
      CMPA #$35
      BHS CSPECIAL5

CSPECIAL9
      LDAA #'C
      JSR DATARX
      LDAA #'M
      JSR DATARX
      JMP FINC

CCICLO
      LDAA #'C
      JSR DATARX
      DECB
      CMPB #$30
      BEQ FINC
      JMP CCICLO

CSPECIAL5
      LDAA #'D
      JSR DATARX
      SUBB #5
      CMPB #$30
      BHI CCICLO
      JMP FINC

CSPECIAL
      LDAA #'C
      JSR DATARX
      LDAA #'D
      JSR DATARX

FINC
      RTS

***********************************
* SERIAL
***********************************

SERIAL

      LDAA  #$00    * CONFIG TODO EL PUERTO  A COMO ENTRADAS
      STAA  DDRA    * EL PUERTO A
       
      LDAA  #$FF    * CONFIG TODO EL PUERTO  G COMO SALIDAS
      STAA  DDRG    * EL PUERTO G 

      LDAA  #$00    * SE PONE PUERTO G EN CEROS
      STAA  PORTG


      LDD   #$302C  * CONFIGURA PUERTO SERIAL
      STAA  BAUD    * BAUD  9600  para cristal de 8MHz
      STAB  SCCR2   * HABILITA  RX Y TX PERO INTERRUPCN SOLO RX
      LDAA  #$00
      STAA  SCCR1   * 8 BITS

      LDAA  #$FE    * CONFIG PUERTO D COMO SALIDAS (EXCEPTO PD0)
      STAA  DDRD    * SEA  ENABLE DEL DISPLAY  PD4  Y RS PD3
                     
      
      LDAA  #$04
      STAA  HPRIO

      LDAA  #$00
      TAP
      RTS

***********************************
*  Borra todo
***********************************

BORRA_TODO
      LDAA #0
      STAA $80,X
      INX
      CPX #$20
      BNE BORRA_TODO
      LDX #0

      RTS

***********************************
*  Error en numero maximo
***********************************

MENSAJE_ERROR_MAX
      LDX #MENSAJE_1
      LDY #0
CICLO_ERROR_MAX
      LDAA 0,X
      CMPA #'&
      BEQ SALTE_ERROR_MAX 
      INX
      STAA $80,Y
      INY
      JMP CICLO_ERROR_MAX
      
SALTE_ERROR_MAX
      RTS

***********************************
*  Error por simbolo invalido
***********************************

MENSAJE_ERROR_SIMBOLO
      LDX #MENSAJE_2
      LDY #0
CICLO_ERROR_SIMBOLO
      LDAA 0,X
      CMPA #'&
      BEQ SALTE_ERROR_SIMBOLO
      INX
      STAA $80,Y
      INY
      JMP CICLO_ERROR_SIMBOLO
      
SALTE_ERROR_SIMBOLO
      RTS

***********************************
*  Romano
***********************************

ROMANO
      CMPA #'I
      BEQ CONFIRMA_ROMANO
      CMPA #'V
      BEQ CONFIRMA_ROMANO
      CMPA #'X
      BEQ CONFIRMA_ROMANO
      CMPA #'L
      BEQ CONFIRMA_ROMANO
      CMPA #'C
      BEQ CONFIRMA_ROMANO
      CMPA #'D
      BEQ CONFIRMA_ROMANO
      CMPA #'M
      BEQ CONFIRMA_ROMANO
      JMP ERROR_FORMA_ROMANO

CONFIRMA_ROMANO
      LDAB #1
      STAB FCR
      JMP CORRECT_ROMANO

ERROR_FORMA_ROMANO
      LDAB #1
      STAB FER

CORRECT_ROMANO
      RTS

***********************************
*  Decimal
***********************************

DECIMAL
      CMPA #$30
      BLO ERROR_FORMA
      CMPA #$39
      BHI ERROR_FORMA
      LDAB #1
      STAB FCD
      JMP CORRECT_DECIMAL

ERROR_FORMA
      LDAB #1
      STAB FED

CORRECT_DECIMAL
      RTS

***********************************
*  DESPLIEGUE DE DATOS
***********************************

DATARX
      STAA $80,X
      INX

      RTS

***********************************
* ATENCION A INTERRUPCION SERIAL
***********************************
      ORG  $F100
  
      PSHA
 
      LDAA SCSR
      LDAA SCDR
      STAA ORDEN

      PULA

      RTI

***********************************
* MENSAJE DE ERROR
***********************************
      ORG $104F
MENSAJE_1  FCC "NUmero fuera del limite&"
MENSAJE_2  FCC "Simbolo invAlido&"

***********************************
* VECTOR INTERRUPCION SERIAL
***********************************
       ORG   $FFD6
       FCB   $F1,$00       

***********************************
*RESET
***********************************
       ORG    $FFFE
RESET  FCB    $80,$00
***********************************
       END   